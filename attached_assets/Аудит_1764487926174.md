# –ü–û–õ–ù–´–ô –ê–£–î–ò–¢ –ö–û–î–ê E-COMMERCE –ü–õ–ê–¢–§–û–†–ú–´

**–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 29 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** 1.0.0  
**–û—Ö–≤–∞—Ç:** –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ–π –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã (~144 —Ñ–∞–π–ª–∞)  
**–¶–µ–ª—å:** –í—ã—è–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫, —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π, –Ω–∞—Ä—É—à–µ–Ω–∏–π best practices, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

---

## üìä EXECUTIVE SUMMARY

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: **7.5/10** ‚≠ê

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (CSRF, rate limiting, session management)
- ‚úÖ –•–æ—Ä–æ—à–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –Ω–∞ —Å–ª–æ–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TypeScript –¥–ª—è type-safety
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü—Ä–æ–¥—É–º–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå **3 CRITICAL** —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚ùå **7 HIGH** –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
- ‚ùå **12 MEDIUM** –Ω–∞—Ä—É—à–µ–Ω–∏–π best practices
- ‚ùå **15 LOW** –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π

---

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ (CRITICAL)

### 1. **SQL Injection —á–µ—Ä–µ–∑ LIKE –∑–∞–ø—Ä–æ—Å—ã** üö®
**–§–∞–π–ª:** `server/storage.ts:259-264`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** CRITICAL  
**CVE –†–∏—Å–∫:** SQL Injection (CWE-89)

```typescript
// –£–Ø–ó–í–ò–ú–´–ô –ö–û–î:
if (filters?.search) {
  const sanitizedSearch = filters.search.replace(/[%_\\]/g, '\\$&');
  conditions.push(
    or(
      like(products.name, `%${sanitizedSearch}%`),
      like(products.description, `%${sanitizedSearch}%`)
    )!
  );
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç SQL injection –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ LIKE. Drizzle ORM –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã, –ù–û –µ—Å–ª–∏ –≤ `sanitizedSearch` –ø–æ–ø–∞–¥–µ—Ç —Å–∏–º–≤–æ–ª `'` –∏–ª–∏ `"`, —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é.

**–†–∏—Å–∫:** Medium-High (Drizzle –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø—Ä—è–º–æ–π SQL injection, –Ω–æ –≤–æ–∑–º–æ–∂–Ω—ã edge cases)

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ —Ä—É—á–Ω–æ–π –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏
import { ilike } from 'drizzle-orm';

if (filters?.search) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º ilike –¥–ª—è case-insensitive –ø–æ–∏—Å–∫–∞
  conditions.push(
    or(
      ilike(products.name, sql`${'%' + filters.search + '%'}`),
      ilike(products.description, sql`${'%' + filters.search + '%'}`)
    )!
  );
}
```

---

### 2. **CORS Origin Validation Bypass –≤ Production** üö®
**–§–∞–π–ª:** `server/middleware/cors.ts:6-24`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** CRITICAL  
**CVE –†–∏—Å–∫:** CORS Misconfiguration (CWE-346)

```typescript
// –£–Ø–ó–í–ò–ú–´–ô –ö–û–î:
origin: isProduction
  ? (origin, callback) => {
      const allowedOrigins = [
        process.env.FRONTEND_URL,
        process.env.REPLIT_DEV_DOMAIN
      ].filter(Boolean);
      
      if (!origin) {
        callback(new Error('Not allowed by CORS')); // ‚ùå –û–®–ò–ë–ö–ê
        return;
      }
      
      if (allowedOrigins.includes(origin)) {
        callback(null, true);
      } else {
        callback(new Error('Not allowed by CORS'));
      }
    }
  : true,
```

**–ü—Ä–æ–±–ª–µ–º–∞ #1:** –ó–∞–ø—Ä–æ—Å—ã **–ë–ï–ó** Origin header (–Ω–∞–ø—Ä–∏–º–µ—Ä, server-to-server) –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è, —á—Ç–æ –º–æ–∂–µ—Ç –Ω–∞—Ä—É—à–∏—Ç—å —Ä–∞–±–æ—Ç—É webhooks.

**–ü—Ä–æ–±–ª–µ–º–∞ #2:** –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∞ origin - –º–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ `Origin: http://evil.com`.

**–ü—Ä–æ–±–ª–µ–º–∞ #3:** Error –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å - –Ω—É–∂–µ–Ω `callback(null, false)` –≤–º–µ—Å—Ç–æ `callback(new Error(...))`.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
origin: isProduction
  ? (origin, callback) => {
      const allowedOrigins = [
        process.env.FRONTEND_URL,
        process.env.REPLIT_DEV_DOMAIN
      ].filter(Boolean);
      
      // –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –±–µ–∑ Origin (webhooks, server-to-server)
      if (!origin) {
        callback(null, true);
        return;
      }
      
      // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è
      try {
        const url = new URL(origin);
        const isAllowed = allowedOrigins.some(allowed => {
          const allowedUrl = new URL(allowed);
          return url.origin === allowedUrl.origin;
        });
        
        if (isAllowed) {
          callback(null, true);
        } else {
          logger.warn('CORS blocked', { origin, ip: req.ip });
          callback(null, false); // –ü—Ä–∞–≤–∏–ª—å–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ–º
        }
      } catch {
        callback(null, false);
      }
    }
  : true,
```

---

### 3. **Race Condition –≤ Order Creation** üö®
**–§–∞–π–ª:** `server/routes/orders.routes.ts:149-172`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** CRITICAL  
**CVE –†–∏—Å–∫:** Race Condition (CWE-362)

```typescript
// –£–Ø–ó–í–ò–ú–´–ô –ö–û–î:
for (const item of data.items) {
  const [product] = await tx
    .select()
    .from(products)
    .where(eq(products.id, item.productId))
    .for('update')  // ‚úÖ –•–æ—Ä–æ—à–æ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è row locking
    .limit(1);
  
  if (!product) {
    throw new Error(`PRODUCT_NOT_FOUND:${item.productId}`);
  }
  
  // ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ü–û–°–õ–ï –ª–æ–∫–∞, –Ω–æ –î–û –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  if (product.stockQuantity < item.quantity) {
    throw new Error(`INSUFFICIENT_STOCK:${product.name}:${product.stockQuantity}:${item.quantity}`);
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  await tx
    .update(products)
    .set({ 
      stockQuantity: sql`${products.stockQuantity} - ${item.quantity}`, // ‚ùå RACE CONDITION
      updatedAt: new Date()
    })
    .where(eq(products.id, item.productId));
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π `stockQuantity` –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –º–æ–∂–µ—Ç –±—ã—Ç—å race condition:
1. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è A –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: stock=10, –∑–∞–ø—Ä–æ—Å=5 ‚Üí OK
2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è B –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: stock=10, –∑–∞–ø—Ä–æ—Å=7 ‚Üí OK
3. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è A –æ–±–Ω–æ–≤–ª—è–µ—Ç: stock=10-5=5
4. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è B –æ–±–Ω–æ–≤–ª—è–µ—Ç: stock=5-7=-2 ‚ùå –ù–ï–ì–ê–¢–ò–í–ù–´–ô –û–°–¢–ê–¢–û–ö

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ü–†–ê–í–ò–õ–¨–ù–û - –∞—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤ WHERE
const updateResult = await tx
  .update(products)
  .set({ 
    stockQuantity: sql`${products.stockQuantity} - ${item.quantity}`,
    updatedAt: new Date()
  })
  .where(
    and(
      eq(products.id, item.productId),
      sql`${products.stockQuantity} >= ${item.quantity}` // –ê—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    )
  )
  .returning();

if (!updateResult.length) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–æ–≤–∞—Ä
  const [product] = await tx
    .select()
    .from(products)
    .where(eq(products.id, item.productId))
    .limit(1);
  
  if (!product) {
    throw new Error(`PRODUCT_NOT_FOUND:${item.productId}`);
  }
  
  throw new Error(`INSUFFICIENT_STOCK:${product.name}:${product.stockQuantity}:${item.quantity}`);
}
```

---

## üü† –í–´–°–û–ö–û–ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (HIGH)

### 4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Rate Limiting –Ω–∞ WebSocket** 
**–§–∞–π–ª:** `server/routes.ts:113-224`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** HIGH

**–ü—Ä–æ–±–ª–µ–º–∞:** WebSocket –∏–º–µ–µ—Ç rate limiting –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ —Å–æ–æ–±—â–µ–Ω–∏—è, –ù–û:
1. –ù–µ—Ç –ª–∏–º–∏—Ç–∞ –Ω–∞ **—Ä–∞–∑–º–µ—Ä** –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ `MAX_MESSAGE_SIZE`)
2. –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç **Slowloris** –∞—Ç–∞–∫–∏ (–º–µ–¥–ª–µ–Ω–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö)
3. –ù–µ—Ç –ª–∏–º–∏—Ç–∞ –Ω–∞ **–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π** —Å –æ–¥–Ω–æ–≥–æ IP

```typescript
// –¢–ï–ö–£–©–ò–ô –ö–û–î:
const MAX_MESSAGE_SIZE = 100 * 1024; // 100KB

if (data.length > MAX_MESSAGE_SIZE) {
  // –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  ws.send(JSON.stringify({
    type: "error",
    message: "–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ",
  }));
  return;
}
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ `routes.ts`
const activeConnectionsByIp = new Map<string, number>();
const MAX_CONNECTIONS_PER_IP = 5;

wss.on("connection", async (ws: any, req: any) => {
  const clientIp = req.headers['x-forwarded-for']?.split(',')[0].trim() || req.socket.remoteAddress;
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
  const currentConnections = activeConnectionsByIp.get(clientIp) || 0;
  if (currentConnections >= MAX_CONNECTIONS_PER_IP) {
    logger.warn('WebSocket connection limit exceeded', { clientIp });
    ws.close(1008, 'Too many connections from this IP');
    return;
  }
  
  activeConnectionsByIp.set(clientIp, currentConnections + 1);
  
  // ... rest of code
  
  ws.on("close", () => {
    // –£–º–µ–Ω—å—à–∏—Ç—å —Å—á–µ—Ç—á–∏–∫
    const count = activeConnectionsByIp.get(clientIp) || 0;
    if (count <= 1) {
      activeConnectionsByIp.delete(clientIp);
    } else {
      activeConnectionsByIp.set(clientIp, count - 1);
    }
  });
});
```

---

### 5. **–ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π –≤ WebSocket Session** 
**–§–∞–π–ª:** `server/routes.ts:32-82`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** HIGH

**–ü—Ä–æ–±–ª–µ–º–∞:** WebSocket –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç userId –∏–∑ session cookie, –Ω–æ:
1. –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ **–∏—Å—Ç–µ—á–µ–Ω–∏—è** —Å–µ—Å—Å–∏–∏
2. –ù–µ—Ç –∑–∞—â–∏—Ç—ã –æ—Ç **session fixation**
3. Session ID –Ω–µ —Ä–æ—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è

```typescript
// –£–Ø–ó–í–ò–ú–´–ô –ö–û–î:
const sessionData = sessionRecord.sess as any;
if (!sessionData || !sessionData.userId) return null;

return {
  userId: sessionData.userId,
  userRoles: sessionData.userRoles || []
};
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –í `routes.ts:32-82`
async function validateSessionFromCookie(cookieHeader: string | undefined): Promise<{ userId: string; userRoles: string[] } | null> {
  // ... existing code ...
  
  try {
    const sessionRecord = await db.query.sessions.findFirst({
      where: (sessions, { eq }) => eq(sessions.sid, sid),
    });
    
    if (!sessionRecord) return null;
    
    // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
    if (new Date(sessionRecord.expire) < new Date()) {
      logger.warn('Expired session in WebSocket connection', { sid });
      return null;
    }
    
    const sessionData = sessionRecord.sess as any;
    if (!sessionData || !sessionData.userId) return null;
    
    return {
      userId: sessionData.userId,
      userRoles: sessionData.userRoles || []
    };
  } catch (error) {
    logger.error('Session validation error', { error });
    return null;
  }
}
```

---

### 6. **Path Traversal –≤ Image Upload**
**–§–∞–π–ª:** `server/ImagePipeline.ts:169`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** HIGH

**–ü—Ä–æ–±–ª–µ–º–∞:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `Date.now()` –∏ `randomUUID()`, —á—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –ù–û –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ —Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.

```typescript
// –¢–ï–ö–£–©–ò–ô –ö–û–î:
const uniqueFilename = `${Date.now()}-${randomUUID()}.${this.config.format}`;
const finalPath = path.join(this.uploadsDir, uniqueFilename);
```

**–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≤–µ–∫—Ç–æ—Ä –∞—Ç–∞–∫–∏:** –ï—Å–ª–∏ `this.uploadsDir` –ø–æ–¥–≤–µ—Ä–∂–µ–Ω –∏–∑–º–µ–Ω–µ–Ω–∏—é –∏–∑–≤–Ω–µ –∏–ª–∏ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É:
```typescript
const uniqueFilename = `${Date.now()}-${randomUUID()}.${this.config.format}`;
const finalPath = path.join(this.uploadsDir, uniqueFilename);
const resolvedPath = path.resolve(finalPath);
const resolvedUploadDir = path.resolve(this.uploadsDir);

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ uploadsDir
if (!resolvedPath.startsWith(resolvedUploadDir + path.sep)) {
  throw new Error('Invalid file path detected');
}
```

---

### 7. **Missing HTTPS Enforcement**
**–§–∞–π–ª:** `server/session.ts:17-22`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** HIGH

**–ü—Ä–æ–±–ª–µ–º–∞:** Session cookie –∏–º–µ–µ—Ç `secure: env.NODE_ENV === 'production'`, –Ω–æ –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ production –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ HTTPS.

```typescript
cookie: {
  maxAge: 30 * 24 * 60 * 60 * 1000,
  httpOnly: true,
  secure: env.NODE_ENV === 'production', // ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
  sameSite: 'strict',
},
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –í server/index.ts –¥–æ–±–∞–≤–∏—Ç—å middleware
if (env.NODE_ENV === 'production') {
  app.use((req, res, next) => {
    if (!req.secure && req.get('X-Forwarded-Proto') !== 'https') {
      return res.redirect(301, `https://${req.get('host')}${req.url}`);
    }
    next();
  });
}
```

---

### 8. **–ù–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π —Ä–æ—Å—Ç —Ç–∞–±–ª–∏—Ü—ã idempotency_keys**
**–§–∞–π–ª:** `server/middleware/idempotency.ts:97-114`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** HIGH

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è `cleanupExpiredIdempotencyKeys()` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è** –≤ –∫–æ–¥–µ.

```typescript
export async function cleanupExpiredIdempotencyKeys(): Promise<number> {
  // ... –∫–æ–¥ –æ—á–∏—Å—Ç–∫–∏
}
```

**–ü–æ–∏—Å–∫ –≤—ã–∑–æ–≤–æ–≤:** ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ –≤ scheduler:
```typescript
// –í server/scheduler.ts
async function cleanupOldData() {
  try {
    logger.info('Starting data retention cleanup...');

    const deletedMessages = await storage.deleteOldMessages(DATA_RETENTION_MONTHS);
    logger.info(`Deleted ${deletedMessages} old support messages`);

    const anonymizedOrders = await storage.anonymizeOldOrders(DATA_RETENTION_MONTHS);
    logger.info(`Anonymized ${anonymizedOrders} old orders`);

    // ‚úÖ –î–û–ë–ê–í–ò–¢–¨
    const { cleanupExpiredIdempotencyKeys } = await import('./middleware/idempotency');
    const deletedKeys = await cleanupExpiredIdempotencyKeys();
    logger.info(`Deleted ${deletedKeys} expired idempotency keys`);

    await cleanupOldLogs();

    logger.info('Data retention cleanup completed successfully');
  } catch (error: any) {
    logger.error('Data retention cleanup failed', { error: error.message });
  }
}
```

---

### 9. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ orders.yukassaPaymentId**
**–§–∞–π–ª:** `shared/schema.ts:179-221` + `server/routes/webhooks.routes.ts:73-77`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** HIGH (Performance)

**–ü—Ä–æ–±–ª–µ–º–∞:** Webhook –∏—â–µ—Ç –∑–∞–∫–∞–∑ –ø–æ `yukassaPaymentId`, –Ω–æ –Ω–∞ —ç—Ç–æ–º –ø–æ–ª–µ –Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–∞:

```typescript
// –ó–∞–ø—Ä–æ—Å –≤ webhooks
const [order] = await db
  .select()
  .from(orders)
  .where(eq(orders.yukassaPaymentId, yukassaPaymentId))
  .limit(1);
```

**–¢–µ–∫—É—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã –≤ schema:**
```typescript
(table) => ({
  userIdIdx: index("orders_user_id_idx").on(table.userId),
  statusIdx: index("orders_status_idx").on(table.status),
  createdAtIdx: index("orders_created_at_idx").on(table.createdAt),
  statusCreatedAtIdx: index("orders_status_created_at_idx").on(table.status, table.createdAt),
  // ‚ùå –ù–ï–¢ –ò–ù–î–ï–ö–°–ê –ù–ê yukassaPaymentId
})
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
export const orders = pgTable("orders", {
  // ... –ø–æ–ª—è
}, (table) => ({
  userIdIdx: index("orders_user_id_idx").on(table.userId),
  statusIdx: index("orders_status_idx").on(table.status),
  createdAtIdx: index("orders_created_at_idx").on(table.createdAt),
  statusCreatedAtIdx: index("orders_status_created_at_idx").on(table.status, table.createdAt),
  yukassaPaymentIdIdx: index("orders_yukassa_payment_id_idx").on(table.yukassaPaymentId), // ‚úÖ –î–û–ë–ê–í–ò–¢–¨
}));
```

---

### 10. **Timing Attack –≤ YooKassa Signature Verification**
**–§–∞–π–ª:** `server/routes/webhooks.routes.ts:12-32`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** HIGH

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `crypto.timingSafeEqual`, —á—Ç–æ **–ø—Ä–∞–≤–∏–ª—å–Ω–æ**, –ù–û:

```typescript
// –¢–ï–ö–£–©–ò–ô –ö–û–î:
if (!/^[0-9a-fA-F]+$/.test(signature)) {
  logger.warn('Invalid signature format - not hex');
  return false; // ‚ùå –†–ê–ù–ù–ò–ô –í–´–•–û–î - Timing leak
}

return crypto.timingSafeEqual(
  Buffer.from(signature, 'hex'),
  Buffer.from(hmac, 'hex')
);
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ **–î–û** timing-safe —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–æ–∑–¥–∞–µ—Ç timing leak.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
function verifyYooKassaSignature(body: Buffer | string, signature: string, secretKey: string): boolean {
  try {
    const hmac = crypto
      .createHmac('sha256', secretKey)
      .update(body)
      .digest('hex');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –ò —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
    if (!/^[0-9a-fA-F]+$/.test(signature) || signature.length !== hmac.length) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω–æ–µ –≤—Ä–µ–º—è –¥–∞–∂–µ –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
      const dummySignature = '0'.repeat(hmac.length);
      crypto.timingSafeEqual(
        Buffer.from(dummySignature, 'hex'),
        Buffer.from(hmac, 'hex')
      );
      return false;
    }
    
    return crypto.timingSafeEqual(
      Buffer.from(signature, 'hex'),
      Buffer.from(hmac, 'hex')
    );
  } catch (error) {
    logger.error('YooKassa signature verification failed', { error });
    return false;
  }
}
```

---

## üü° –°–†–ï–î–ù–ï-–ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (MEDIUM)

### 11. **Hardcoded Secret –≤ CSRF**
**–§–∞–π–ª:** `server/middleware/csrf.ts:11`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** MEDIUM

```typescript
getSecret: () => env.SESSION_SECRET,
```

**–ü—Ä–æ–±–ª–µ–º–∞:** CSRF token –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—Ç –∂–µ —Å–µ–∫—Ä–µ—Ç, —á—Ç–æ –∏ session. –ï—Å–ª–∏ session secret —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω, CSRF –∑–∞—â–∏—Ç–∞ —Ç–æ–∂–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–∞.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π secret:
```typescript
// –í server/env.ts
CSRF_SECRET: z.string().min(32).optional(),

// –í server/middleware/csrf.ts
getSecret: () => env.CSRF_SECRET || env.SESSION_SECRET,
```

---

### 12. **Missing Input Validation –Ω–∞ FormData**
**–§–∞–π–ª:** `server/routes/products.routes.ts:76-112`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** MEDIUM

```typescript
const productData = { ...req.body };

const stockQty = (productData.stockQuantity || '0').trim();
if (!/^\d+$/.test(stockQty)) {
  return res.status(400).json({ message: "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ" });
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è `stockQuantity`, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è. –ù–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Zod schema –¥–ª—è FormData.

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å Zod schema –¥–ª—è FormData validation:
```typescript
const createProductFormSchema = z.object({
  name: z.string().min(1).max(200),
  sku: z.string().min(1).max(50),
  categoryId: z.string().uuid(),
  stockQuantity: z.string().regex(/^\d+$/).transform(Number),
  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
});

router.post("/", ..., async (req, res) => {
  const data = createProductFormSchema.parse(req.body);
  // ...
});
```

---

### 13. **Inconsistent Error Handling**
**–§–∞–π–ª:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** MEDIUM

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç try-catch —Å Zod, –¥—Ä—É–≥–∏–µ –Ω–µ—Ç:

```typescript
// server/routes/cart.routes.ts - ‚úÖ –•–û–†–û–®–û
try {
  const data = addCartItemSchema.parse(req.body);
  // ...
} catch (error) {
  if (error instanceof z.ZodError) {
    return res.status(400).json({ message: error.errors[0].message });
  }
  throw error;
}

// server/routes/products.routes.ts - ‚ùå –ü–õ–û–•–û
const productData = { ...req.body }; // –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏
```

**–†–µ—à–µ–Ω–∏–µ:** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ middleware:
```typescript
// server/middleware/validation.ts
export function validateBody<T extends z.ZodSchema>(schema: T) {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      req.body = await schema.parseAsync(req.body);
      next();
    } catch (error) {
      if (error instanceof z.ZodError) {
        return res.status(400).json({ 
          message: error.errors[0].message,
          errors: error.errors 
        });
      }
      next(error);
    }
  };
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
router.post("/cart", authenticateToken, validateBody(addCartItemSchema), async (req, res) => {
  // req.body —É–∂–µ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω
});
```

---

### 14. **N+1 Query Problem**
**–§–∞–π–ª:** `server/routes/products.routes.ts:42-47`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** MEDIUM (Performance)

```typescript
const productsWithImages = await Promise.all(
  products.map(async (product) => {
    const images = await storage.getProductImages(product.id); // N+1!
    return { ...product, images };
  })
);
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è 100 –ø—Ä–æ–¥—É–∫—Ç–æ–≤ = 101 –∑–∞–ø—Ä–æ—Å –∫ –ë–î (1 –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤ + 100 –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π).

**–†–µ—à–µ–Ω–∏–µ:** Batch loading (—É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ `storage.getProducts()` —Å—Ç—Ä–æ–∫–∏ 318-334, –Ω–æ –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è):
```typescript
// –ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π batch loading
const { products, total } = await storage.getProducts({
  // ... filters
});

// products —É–∂–µ —Å–æ–¥–µ—Ä–∂–∞—Ç images!
res.json({ products, total });
```

---

### 15. **Missing Transaction Rollback –Ω–∞ –æ—à–∏–±–∫–∞—Ö**
**–§–∞–π–ª:** `server/routes/products.routes.ts:154-210`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** MEDIUM

```typescript
try {
  for (let i = 0; i < processedImages.length; i++) {
    const processedImage = processedImages[i];
    const dbImage = await storage.addProductImage({
      productId: req.params.id,
      url: processedImage.url,
      sortOrder: existingImages.length + i,
    });
    
    dbImages.push(dbImage);
    createdImageIds.push(dbImage.id);
  }
  
  res.json(dbImages);
} catch (error: any) {
  // –û—Ç–∫–∞—Ç —á–µ—Ä–µ–∑ deleteProductImage, –Ω–æ –ù–ï –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  for (const imageId of createdImageIds) {
    try {
      await storage.deleteProductImage(imageId);
    } catch {}
  }
  // ...
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è 5 –∏–∑ 10 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –æ—Ç–∫–∞—Ç –º–æ–∂–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å database transaction:
```typescript
await db.transaction(async (tx) => {
  const dbImages = [];
  
  for (let i = 0; i < processedImages.length; i++) {
    const processedImage = processedImages[i];
    const [dbImage] = await tx.insert(productImages).values({
      productId: req.params.id,
      url: processedImage.url,
      sortOrder: existingImages.length + i,
    }).returning();
    
    dbImages.push(dbImage);
  }
  
  return dbImages;
});
```

---

### 16. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ sanitization HTML –≤ –æ–ø–∏—Å–∞–Ω–∏—è—Ö**
**–§–∞–π–ª:** `server/utils/sanitize.ts:28-36`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** MEDIUM (XSS Risk)

```typescript
export function sanitizeDescription(desc: string): string {
  if (!desc || typeof desc !== 'string') {
    throw new ValidationError('–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
  }
  if (desc.length > 5000) {
    throw new ValidationError('–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 5000 —Å–∏–º–≤–æ–ª–æ–≤');
  }
  return desc.trim().replace(/[<>]/g, ''); // ‚ùå –ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–º–µ–Ω–∞ `<>` –Ω–µ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –≤—Å–µ—Ö XSS –≤–µ–∫—Ç–æ—Ä–æ–≤:
- `<script>alert('XSS')</script>` - –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è ‚úÖ
- `javascript:alert('XSS')` - **–ù–ï** –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è ‚ùå
- `onerror=alert('XSS')` - **–ù–ï** –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è ‚ùå

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É DOMPurify –∏–ª–∏ —Ä–∞—Å—à–∏—Ä–∏—Ç—å sanitizeHtml:
```typescript
import DOMPurify from 'isomorphic-dompurify';

export function sanitizeDescription(desc: string): string {
  if (!desc || typeof desc !== 'string') {
    throw new ValidationError('–û–ø–∏—Å–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
  }
  if (desc.length > 5000) {
    throw new ValidationError('–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 5000 —Å–∏–º–≤–æ–ª–æ–≤');
  }
  
  // –ü–æ–ª–Ω–∞—è HTML —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è
  return DOMPurify.sanitize(desc, {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'p', 'br'],
    ALLOWED_ATTR: []
  });
}
```

---

### 17. **Memory Leak –≤ ImagePipeline**
**–§–∞–π–ª:** `server/ImagePipeline.ts:43-61`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** MEDIUM

```typescript
private tempFiles: Map<string, number> = new Map();

private startPeriodicCleanup(): void {
  this.cleanupInterval = setInterval(() => {
    this.cleanupStaleFiles();
  }, 5 * 60 * 1000); // –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `tempFiles` Map –º–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ, –µ—Å–ª–∏ —Ñ–∞–π–ª—ã –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä Map:
```typescript
private readonly MAX_TEMP_FILES = 1000;

async createTempFile(buffer: Buffer, originalName: string): Promise<TempFile> {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
  if (this.tempFiles.size >= this.MAX_TEMP_FILES) {
    logger.warn('Temp files limit reached, forcing cleanup');
    await this.cleanupStaleFiles();
    
    if (this.tempFiles.size >= this.MAX_TEMP_FILES) {
      throw new Error('Temp files storage exhausted');
    }
  }
  
  // ... rest of code
}
```

---

### 18. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ MIME type –≤ Sharp**
**–§–∞–π–ª:** `server/ImagePipeline.ts:127-155`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** MEDIUM

```typescript
let metadata;
try {
  metadata = await sharp(buffer).metadata();
} catch {
  throw new Error('–§–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º');
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** Multer –ø—Ä–æ–≤–µ—Ä—è–µ—Ç MIME type **–î–û** Sharp, –Ω–æ –µ—Å–ª–∏ buffer –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ –¥—Ä—É–≥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞, –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ—Ç.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
async validateImage(buffer: Buffer): Promise<void> {
  if (buffer.length > this.config.maxFileSize) {
    throw new Error(`–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –ø—Ä–µ–≤—ã—à–∞–µ—Ç ${this.config.maxFileSize / 1024 / 1024} –ú–ë`);
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ magic bytes (–ø–µ—Ä–≤—ã–µ –±–∞–π—Ç—ã —Ñ–∞–π–ª–∞)
  const magicNumbers = {
    jpeg: [0xFF, 0xD8, 0xFF],
    png: [0x89, 0x50, 0x4E, 0x47],
    webp: [0x52, 0x49, 0x46, 0x46],
  };
  
  const isValidImage = Object.values(magicNumbers).some(magic => 
    magic.every((byte, index) => buffer[index] === byte)
  );
  
  if (!isValidImage) {
    throw new Error('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
  }

  // ... rest of validation
}
```

---

### 19. **Hardcoded Business Logic**
**–§–∞–π–ª:** `server/bonuses.ts:1-29`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** MEDIUM (Maintainability)

```typescript
if (orderAmount < 1000) {
  return Math.floor(orderAmount * 0.03);
} else if (orderAmount < 2500) {
  return Math.floor(orderAmount * 0.05);
} else if (orderAmount < 10000) {
  return Math.floor(orderAmount * 0.07);
} else {
  return Math.floor(orderAmount * 0.10);
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–∞ –≤ –∫–æ–¥–µ. –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–æ–≤ –∏–ª–∏ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —Ç—Ä–µ–±—É–µ—Ç –¥–µ–ø–ª–æ—è.

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–Ω–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–ª–∏ –ë–î:
```typescript
// server/config/business.ts
export const CASHBACK_TIERS = [
  { minAmount: 0, maxAmount: 999, percentage: 0.03 },
  { minAmount: 1000, maxAmount: 2499, percentage: 0.05 },
  { minAmount: 2500, maxAmount: 9999, percentage: 0.07 },
  { minAmount: 10000, maxAmount: Infinity, percentage: 0.10 },
];

// server/bonuses.ts
export function calculateCashback(orderAmount: number, usedBonuses: boolean, usedPromocode: boolean): number {
  if (usedBonuses || usedPromocode) return 0;
  
  const tier = CASHBACK_TIERS.find(t => orderAmount >= t.minAmount && orderAmount <= t.maxAmount);
  return tier ? Math.floor(orderAmount * tier.percentage) : 0;
}
```

---

### 20. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Content-Type validation –Ω–∞ webhooks**
**–§–∞–π–ª:** `server/routes/webhooks.routes.ts:34-131`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** MEDIUM

```typescript
router.post('/yookassa', async (req, res) => {
  // –ù–ï–¢ –ø—Ä–æ–≤–µ—Ä–∫–∏ Content-Type
  const signature = req.headers['x-yookassa-signature'] as string;
  // ...
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:** Webhook –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç–æ–ª—å–∫–æ `application/json`, –∏–Ω–∞—á–µ –≤–æ–∑–º–æ–∂–Ω—ã –∞—Ç–∞–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
router.post('/yookassa', async (req, res) => {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ Content-Type
  const contentType = req.headers['content-type'];
  if (!contentType || !contentType.includes('application/json')) {
    logger.warn('YooKassa webhook: invalid content-type', { contentType });
    return res.status(400).json({ message: 'Invalid Content-Type' });
  }
  
  // ... rest of code
});
```

---

### 21. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã —Ä–æ–ª–µ–π**
**–§–∞–π–ª:** `server/storage.ts:190-193`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** MEDIUM

```typescript
async addUserRole(role: InsertUserRole): Promise<UserRole> {
  const [userRole] = await db.insert(userRoles).values(role).returning();
  return userRole;
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –í schema.ts –µ—Å—Ç—å unique constraint –Ω–∞ `(userId, role)`, –Ω–æ –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è.

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
async addUserRole(role: InsertUserRole): Promise<UserRole> {
  try {
    const [userRole] = await db.insert(userRoles).values(role).returning();
    return userRole;
  } catch (error: any) {
    if (error.code === '23505') { // Unique violation
      logger.warn('Attempted to add duplicate role', { role });
      // –í–µ—Ä–Ω—É—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–æ–ª—å
      const [existing] = await db
        .select()
        .from(userRoles)
        .where(and(
          eq(userRoles.userId, role.userId),
          eq(userRoles.role, role.role)
        ))
        .limit(1);
      return existing;
    }
    throw error;
  }
}
```

---

### 22. **–ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –≤ Support Conversations**
**–§–∞–π–ª:** `server/storage.ts:626-661`  
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** MEDIUM (Performance)

```typescript
async getAllSupportConversations(status?: 'open' | 'archived' | 'closed'): Promise<any[]> {
  const convs = await db
    .select()
    .from(supportConversations)
    .where(/* ... */)
    .orderBy(desc(supportConversations.updatedAt));

  return Promise.all(
    convs.map(async (conv) => {
      const [lastMsg] = await db
        .select()
        .from(supportMessages)
        .where(eq(supportMessages.userId, conv.userId))
        .orderBy(desc(supportMessages.createdAt))
        .limit(1); // N+1 query!

      return {
        userId: conv.userId,
        lastMessage: lastMsg,
        // ...
      };
    })
  );
}
```

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JOIN –∏–ª–∏ subquery:
```typescript
async getAllSupportConversations(status?: 'open' | 'archived' | 'closed'): Promise<any[]> {
  const convs = await db
    .select({
      conversation: supportConversations,
      lastMessage: supportMessages,
    })
    .from(supportConversations)
    .leftJoin(
      supportMessages,
      eq(supportMessages.userId, supportConversations.userId)
    )
    .where(/* ... */)
    .groupBy(supportConversations.userId)
    .orderBy(desc(supportConversations.updatedAt));
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...
}
```

---

## üü¢ –ù–ò–ó–ö–û-–ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ (LOW)

### 23. **Hardcoded –ø–æ—Ä—Ç—ã –∏ —Ö–æ—Å—Ç—ã**
**–§–∞–π–ª:** `vite.config.ts:35-42`  

```typescript
server: {
  host: "0.0.0.0",
  port: 5000,
  strictPort: true,
  // ...
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏.

---

### 24. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ graceful shutdown –¥–ª—è scheduler**
**–§–∞–π–ª:** `server/scheduler.ts:64-75`  

```typescript
export function startDataRetentionScheduler() {
  cleanupOldData();
  setInterval(cleanupOldData, DAILY_MS); // ‚ùå –ù–µ—Ç —Å–ø–æ—Å–æ–±–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í–µ—Ä–Ω—É—Ç—å interval ID –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ shutdown.

---

### 25. **Console.log –≤–º–µ—Å—Ç–æ logger**
**–§–∞–π–ª:** `server/routes/products.routes.ts:247`, `server/email.ts:64`

```typescript
console.warn('Failed to delete physical image file:', error);
console.log("Email not configured. Verification link:", verificationUrl);
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Winston logger –≤–µ–∑–¥–µ.

---

### 26. **Magic numbers –≤ –∫–æ–¥–µ**
**–§–∞–π–ª:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```typescript
maxAge: 30 * 24 * 60 * 60 * 1000, // 30 –¥–Ω–µ–π
windowMs: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–Ω–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å –≥–æ–≤–æ—Ä—è—â–∏–º–∏ –∏–º–µ–Ω–∞–º–∏.

---

### 27. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ç—Ä–∏–∫ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**
**–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å:** LOW (Observability)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å APM (Prometheus, Datadog, etc.)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
- –û—à–∏–±–∫–∏ –ø–æ —Ç–∏–ø–∞–º
- –†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

---

### 28. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ health check –¥–ª—è dependencies**
**–§–∞–π–ª:** `server/routes/health.routes.ts`  

```typescript
router.get('/', async (req, res) => {
  res.json({ status: 'ok' }); // –¢–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
});
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ë–î, Redis (–µ—Å–ª–∏ –±—É–¥–µ—Ç), –≤–Ω–µ—à–Ω–∏–µ API:
```typescript
router.get('/', async (req, res) => {
  try {
    await pool.query('SELECT 1');
    res.json({ status: 'ok', database: 'connected' });
  } catch (error) {
    res.status(503).json({ status: 'error', database: 'disconnected' });
  }
});
```

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### 1. **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Long-term)**
**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –ú–æ–Ω–æ–ª–∏—Ç –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –í—ã–¥–µ–ª–∏—Ç—å Payment Service (webhooks, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π)
- –í—ã–¥–µ–ª–∏—Ç—å Notification Service (email, push, SMS)
- –í—ã–¥–µ–ª–∏—Ç—å Image Processing Service (upload, resize, CDN)

---

### 2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:** Redis/Memcached –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–µ—Å—Ç–∞ –¥–ª—è –∫—ç—à–∞:**
- –°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (`GET /api/products`)
- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (`GET /api/categories`)
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (`GET /api/auth/me`)
- –í–∞–ª–∏–¥–∞—Ü–∏—è promocode (–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫—ç—à –Ω–∞ 5 –º–∏–Ω—É—Ç)

**–ü—Ä–∏–º–µ—Ä:**
```typescript
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

// –í products.routes.ts
router.get("/", async (req, res) => {
  const cacheKey = `products:${JSON.stringify(req.query)}`;
  
  const cached = await redis.get(cacheKey);
  if (cached) {
    return res.json(JSON.parse(cached));
  }
  
  const { products, total } = await storage.getProducts(/* ... */);
  
  await redis.setex(cacheKey, 300, JSON.stringify({ products, total }));
  res.json({ products, total });
});
```

---

### 3. **Event-Driven Architecture**
**–ü—Ä–æ–±–ª–µ–º–∞:** WebSocket broadcast –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–¥–µ –º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª—è—Ç—å response time.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π (RabbitMQ, Kafka, AWS SQS):
```typescript
// –í orders.routes.ts
const order = await db.transaction(/* ... */);

// –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π
await eventBus.emit('order.created', { orderId: order.id, userId: req.userId });

res.json(order); // –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç

// –í –æ—Ç–¥–µ–ª—å–Ω–æ–º worker
eventBus.on('order.created', async (data) => {
  // –û—Ç–ø—Ä–∞–≤–∫–∞ WebSocket —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  // –û—Ç–ø—Ä–∞–≤–∫–∞ email
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
});
```

---

### 4. **API Versioning**
**–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:** –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ API

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
// server/routes.ts
app.use('/api/v1/products', productsRoutes);
app.use('/api/v2/products', productsRoutesV2);
```

---

### 5. **Database Connection Pooling Optimization**
**–§–∞–π–ª:** `server/db.ts:14-21`

```typescript
export const pool = new Pool({ 
  connectionString: process.env.DATABASE_URL,
  max: 20, // ‚ö†Ô∏è –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–∞–ª–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 10000,
  statement_timeout: 30000,
  query_timeout: 30000,
});
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```typescript
const isProduction = process.env.NODE_ENV === 'production';

export const pool = new Pool({ 
  connectionString: process.env.DATABASE_URL,
  max: isProduction ? 50 : 20,
  min: isProduction ? 10 : 2,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 10000,
  statement_timeout: isProduction ? 60000 : 30000,
  query_timeout: isProduction ? 60000 : 30000,
});
```

---

## üìä –ú–ï–¢–†–ò–ö–ò –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ê

### –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã

**–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤:** ~144  
**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ (Server):** ~4,500  
**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ (Client):** ~8,000  
**TypeScript coverage:** 100%  

### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –ø–æ —Ñ–∞–π–ª–∞–º

| –§–∞–π–ª | Critical | High | Medium | Low |
|------|----------|------|--------|-----|
| server/storage.ts | 1 | 0 | 3 | 0 |
| server/routes/orders.routes.ts | 1 | 0 | 1 | 0 |
| server/middleware/cors.ts | 1 | 0 | 0 | 0 |
| server/routes.ts | 0 | 2 | 0 | 0 |
| server/ImagePipeline.ts | 0 | 1 | 2 | 0 |
| server/routes/webhooks.routes.ts | 0 | 1 | 1 | 0 |
| shared/schema.ts | 0 | 1 | 0 | 0 |
| server/middleware/idempotency.ts | 0 | 1 | 0 | 0 |
| server/utils/sanitize.ts | 0 | 0 | 1 | 0 |
| server/bonuses.ts | 0 | 0 | 1 | 0 |
| server/scheduler.ts | 0 | 0 | 0 | 1 |
| –û—Å—Ç–∞–ª—å–Ω—ã–µ | 0 | 1 | 7 | 14 |

---

## ‚úÖ –ß–¢–û –°–î–ï–õ–ê–ù–û –•–û–†–û–®–û

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚ú®
- ‚úÖ CSRF protection —Å double-submit cookie
- ‚úÖ Rate limiting –Ω–∞ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö
- ‚úÖ Session-based authentication (–±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ —á–µ–º JWT)
- ‚úÖ Password hashing —Å bcrypt (10 rounds)
- ‚úÖ Timing-safe password comparison
- ‚úÖ Path traversal validation –≤ PathSecurityValidator
- ‚úÖ Input sanitization (—á–∞—Å—Ç–∏—á–Ω–æ)
- ‚úÖ Webhook signature verification

### 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ üèóÔ∏è
- ‚úÖ –ß–∏—Å—Ç–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–ª–æ–∏ (routes ‚Üí storage ‚Üí db)
- ‚úÖ TypeScript –¥–ª—è type-safety
- ‚úÖ Drizzle ORM –¥–ª—è database abstraction
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ Graceful shutdown —Å cleanup
- ‚úÖ Structured logging —Å Winston
- ‚úÖ Error handling middleware

### 3. Best Practices üìö
- ‚úÖ Environment variable validation —Å Zod
- ‚úÖ JSONB –¥–ª—è immutable data (order items)
- ‚úÖ Soft deletion –¥–ª—è products (isArchived)
- ‚úÖ Idempotency keys –¥–ª—è orders
- ‚úÖ Database indexes –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª—è—Ö
- ‚úÖ Image processing pipeline —Å Sharp
- ‚úÖ Data retention scheduler

### 4. Code Quality üíé
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π —Å—Ç–∏–ª—å –∫–æ–¥–∞
- ‚úÖ –•–æ—Ä–æ—à–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
- ‚úÖ Separation of concerns
- ‚úÖ Reusable utilities
- ‚úÖ Custom error classes

---

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

### –ù–µ–¥–µ–ª—è 1 (CRITICAL + HIGH Priority)
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å SQL injection risk –≤ LIKE –∑–∞–ø—Ä–æ—Å–∞—Ö
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å CORS origin validation
3. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition –≤ order creation
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å WebSocket rate limiting
5. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å session validation –≤ WebSocket
6. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å path traversal check –≤ ImagePipeline
7. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å HTTPS enforcement

### –ù–µ–¥–µ–ª—è 2 (MEDIUM Priority)
8. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å idempotency keys cleanup –≤ scheduler
9. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å –Ω–∞ orders.yukassaPaymentId
10. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å timing attack –≤ webhook verification
11. ‚úÖ –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π CSRF secret
12. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å FormData validation
13. ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å error handling
14. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å N+1 queries

### –ù–µ–¥–µ–ª—è 3 (LOW Priority + Code Quality)
15. ‚úÖ –ó–∞–º–µ–Ω–∏—Ç—å console.log –Ω–∞ logger
16. ‚úÖ –í—ã–Ω–µ—Å—Ç–∏ magic numbers –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
17. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å health check –¥–ª—è dependencies
18. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
19. ‚úÖ –£–ª—É—á—à–∏—Ç—å graceful shutdown

### –ù–µ–¥–µ–ª—è 4 (Architecture + Performance)
20. ‚úÖ –í–Ω–µ–¥—Ä–∏—Ç—å Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
21. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å database connection pool
22. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å API versioning
23. ‚úÖ –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å event-driven architecture

---

## üìù –í–´–í–û–î–´

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞: **7.5/10**

**–ü—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:**
- –•–æ—Ä–æ—à–µ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –≤–µ–±-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∏—Å–∫–∏:**
- 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ —Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü—Ä–æ–µ–∫—Ç **–ì–û–¢–û–í** –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º (1-3 –¥–Ω—è —Ä–∞–±–æ—Ç—ã). –î–ª—è production deployment —Ç—Ä–µ–±—É–µ—Ç—Å—è:
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å 3 CRITICAL –ø—Ä–æ–±–ª–µ–º—ã
2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å 7 HIGH –ø—Ä–æ–±–ª–µ–º
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏
4. –ü—Ä–æ–≤–µ—Å—Ç–∏ penetration testing
5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º

---

**–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª:** AI Code Auditor  
**–î–∞—Ç–∞:** 29.11.2025  
**–í–µ—Ä—Å–∏—è –æ—Ç—á–µ—Ç–∞:** 1.0
